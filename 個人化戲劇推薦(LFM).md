
# 個人化戲劇推薦系統的建立

### 此檔案主要是利用「隱語意演算法」(latent factor model)的計算，計算每個使用者對每部戲劇的個人喜好分數，，再搭配三個推薦策略，得到「個人化+熱門度+最新流行」的推薦結果

## 1. 資料準備

### 1.1 匯入所需要的套件及資料


```python
import pandas as pd
import numpy as np
import math
import scipy
import sys
import random

from scipy import spatial
from collections import Counter
from operator import itemgetter
from collections import defaultdict

tbl_DramaGenre=pd.read_csv('tbl_DramaGenre.csv', encoding='utf-8') #戲劇類型對照表
tbl_Genre=pd.read_csv('tbl_Genre.csv', encoding='utf-8')  #類型基本資料
tbl_Drama=pd.read_csv('tbl_Drama.csv', encoding='utf-8')  #戲劇基本資料
tbl_Actor=pd.read_csv('tbl_Actor.csv', encoding='utf-8')  #演員基本資料
tbl_DramaActor=pd.read_csv('tbl_DramaActor.csv', encoding='utf-8') #戲劇演員對照表
df_drama_ott=pd.read_csv('df_drama_ott.csv', encoding='utf-8') #戲劇OTT平台對照表
df_Drama_GenreName=pd.read_csv('df_Drama_GenreName.csv', encoding='utf-8') #戲劇類型對照表
random_result=pd.read_csv('random_result_5000_v3.csv', encoding='utf-8') #5000筆模擬資料,包括ip、dramaID、收藏日期、收藏次數
random_result2=pd.read_csv('random_result_5000_v2.csv', encoding='utf-8') #5000筆模擬資料,包括ip、dramaID、收藏日期、收藏次數
df_drama_zone_genre_actor_all=pd.read_csv('df_drama_zone_genre_actor_all2.csv', encoding='utf-8') #每部片的地區、類型、演員特徵
```

### 1.2 將5000筆模擬資料整理成dictionary格式，俾利後續CF(user-based)及LFM演算法的計算


```python
def data_processing(histroryDrama, user_ip):
    
    #將5000個使用者的個人ip及dramaID的對應關係整理成dictionary形式
    ip_history_list=list(random_result['ipAddr'].tolist())

    UserItemDict={}
    for i in ip_history_list:
        ll=random_result[random_result['ipAddr']==i]['dramaID'].tolist()
        UserItemDict[i]=ll[0].split("/")
    
    #取得新使用者的收藏片單並且整理成list
    histroryDrama_list=[]
    for i in histroryDrama:
        histroryDrama_list.append(i[1])

    #將新的使用者的看片清單加入5000人的消費者使用清單中(不將新的使用者資料併入5000筆計算基礎中使用)
    UserItemDict[user_ip]=histroryDrama_list
        
    UserItemDictPositiveGrade={}

    if user_ip in ip_history_list:
        ip_history_list_new=ip_history_list
    else:
        ip_history_list_new=ip_history_list+[user_ip]

    for i in ip_history_list_new:
        drama_dic1={}
        for j in UserItemDict[i]:
            drama_dic1[j]=1
            UserItemDictPositiveGrade[i]=drama_dic1
    
    #取得所有戲劇的劇名ID清單
    dramaName_list=list(set(df_drama_zone_genre_actor_all['dramaID']))
    dramaName_list2=list(set(random_result2['dramaID'].tolist()))
    
    
    # 將未觀看過的戲劇加入user-item的字典中並設定對應值為零，以做為計算LFM的基礎
    UserItemDictGrade={}
    for user in list(UserItemDict.keys()):
        itemDict={}
        positiveItemList=UserItemDict[user]
        otherItemList=list(set(dramaName_list2)-set(positiveItemList))
        negativeItemList = random.sample(otherItemList, len(positiveItemList))
        for i in positiveItemList:
            itemDict[i]=1
        for j in negativeItemList:
            itemDict[j]=0
        UserItemDictGrade[user]=itemDict
    
    return UserItemDict, UserItemDictPositiveGrade, UserItemDictGrade, dramaName_list, dramaName_list2
```


```python
histroryDrama=[('127.0.0.1', 'G020073'), ('127.0.0.1', 'G010012'), ('127.0.0.1', 'G010003'), ('127.0.0.1', 'G010002'), \
                  ('127.0.0.1', 'G010005'),('127.0.0.1', 'G010056'), ('127.0.0.1', 'G010169'), ('127.0.0.1', 'G020041') ]

UserItemDict, UserItemDictPositiveGrade, UserItemDictGrade, dramaName_list, dramaName_list2=data_processing(histroryDrama, '127.0.0.1')
```

### 2.「隱語意演算法」(latent factor model)的計算

### 2.1初始化參數


```python
def initParams(k):
    
    p = np.random.rand(len(UserItemDictGrade.keys()), k)
    q = np.random.rand(k, len(dramaName_list2))
    userItem = UserItemDictGrade
    p = pd.DataFrame(p, columns=range(0, k), index=list(UserItemDictGrade.keys()))
    q = pd.DataFrame(q, columns=dramaName_list2, index=range(0, k))
    
    return p, q, userItem
```

### 2.2導入sigmod函數


```python
def sigmod(x):
    y = 1.0000 / (1 + np.exp(-x))
    return y
```

### 2.3利用參數(p,q)預測使用者對戲劇的喜好程度


```python
def predict(p, q, user_ip, dramaID):
    
    r=0.0000
    
    p = np.mat(p.ix[user_ip].values)
    q = np.mat(q[dramaID].values).T
    r = (p * q).sum()
    r = sigmod(r)
    
    return r
```

### 2.4利用資料訓練參數(p,q)


```python
def train(k, iteration_counts, learning_rate, c):
    
    p, q, userItem=initParams(k)
    
    for step in range(1, iteration_counts+1):
        for user_ip, dramas in userItem.items():
            for dramaID, r in dramas.items():
                loss = float(r) - predict(p, q, user_ip, dramaID)
                for kk in range(0, k):
                    p[kk][user_ip] += learning_rate * (loss * q[dramaID][kk] - c * p[kk][user_ip])
                    q[dramaID][kk] += learning_rate * (loss * p[kk][user_ip] - c * q[dramaID][kk])
        if step % 5 == 0:
            learning_rate *= 0.8
    return p, q
```

### 2.5利用訓練好的參數(p,q)計算使用者的喜好分數


```python
def recommand(p, q):
    
    rank_LMF={}
    
    for user_ip in list(UserItemDictGrade.keys()):
        rank_LMF.setdefault(user_ip, defaultdict(int))
        for dramaID in dramaName_list2:
            rank_LMF[user_ip][dramaID]=predict(p, q, user_ip, dramaID)
            
    return rank_LMF
```


```python
p,q = train(5, 5, 0.1, 0.01)
rank_LMF = recommand(p, q)
```

    /home/mintz/anaconda3/lib/python3.6/site-packages/ipykernel_launcher.py:5: DeprecationWarning: 
    .ix is deprecated. Please use
    .loc for label based indexing or
    .iloc for positional indexing
    
    See the documentation here:
    http://pandas.pydata.org/pandas-docs/stable/indexing.html#ix-indexer-is-deprecated
      """
    


```python
rank_sorted_CMF=sorted(rank_LMF['127.0.0.1'].items(), key=itemgetter(1), reverse=True)
```


```python
rank_sorted_CMF
```




    [('G010269', 0.9650727100005918),
     ('G030176', 0.964743640894877),
     ('G010169', 0.9610526128572481),
     ('G030243', 0.9545352665123025),
     ('G020041', 0.9497404810637179),
     ('G010176', 0.9464589160318936),
     ('G010007', 0.9367897007848117),
     ('G020069', 0.9211670429531127),
     ('G010198', 0.9191078865367898),
     ('G010008', 0.900478956692503),
     ('G010243', 0.8979912939303346),
     ('G030104', 0.8965927128527756),
     ('G020102', 0.8952135846339738),
     ('G010260', 0.8944222718212964),
     ('G020050', 0.8895772743693794),
     ('G010075', 0.8893159548979156),
     ('G030277', 0.8832623417145208),
     ('G010271', 0.8824959292392354),
     ('G010162', 0.8802221382076696),
     ('G010306', 0.8785013289850044),
     ('G020010', 0.876705967333144),
     ('G020053', 0.8759248948375563),
     ('G010215', 0.8759083321928093),
     ('G010160', 0.8748741180108759),
     ('G030161', 0.8580858214624254),
     ('G020025', 0.8560913655965339),
     ('G010297', 0.8522083570688044),
     ('G030293', 0.8519793195166503),
     ('G020048', 0.8485612196376708),
     ('G010108', 0.8472474899801503),
     ('G010132', 0.8472131518411146),
     ('G030047', 0.8458445445384823),
     ('G010032', 0.8454845054542709),
     ('G030024', 0.8446524666190007),
     ('G010201', 0.8433416257149386),
     ('G010119', 0.8368442532279604),
     ('G030042', 0.8326088890606885),
     ('G010204', 0.8309621249498171),
     ('G030227', 0.8236734957329894),
     ('G020109', 0.8236581952582805),
     ('G010234', 0.8181886272495513),
     ('G030231', 0.8125866461622793),
     ('G030179', 0.8097376446955105),
     ('G010056', 0.800676976527351),
     ('G010246', 0.7979667348377137),
     ('G010066', 0.7977974629857051),
     ('G010033', 0.7963092405715347),
     ('G030180', 0.793610748815292),
     ('G030070', 0.7831454772807046),
     ('G010235', 0.7828182342865968),
     ('G030113', 0.7791038128887197),
     ('G030330', 0.7776015646123429),
     ('G010223', 0.7761162174256653),
     ('G030229', 0.7727237056882552),
     ('G020118', 0.7694249324320631),
     ('G010111', 0.7682981649507435),
     ('G020105', 0.7677796271316106),
     ('G020082', 0.7665158956470074),
     ('G020014', 0.7614953515890697),
     ('G020096', 0.7608756443005745),
     ('G030036', 0.7594881942330445),
     ('G010166', 0.7593954831618995),
     ('G030320', 0.7538790039786247),
     ('G030245', 0.7534471520337545),
     ('G030149', 0.7532397624998036),
     ('G010014', 0.7524693870914843),
     ('G010222', 0.7501103971401523),
     ('G030092', 0.7451453996298345),
     ('G010140', 0.7433341918793599),
     ('G010253', 0.7334899274853428),
     ('G030143', 0.7318699382037173),
     ('G020064', 0.7297220353525938),
     ('G020094', 0.726732519245404),
     ('G030140', 0.7259170833351498),
     ('G020117', 0.7229233815756544),
     ('G020070', 0.721280898740306),
     ('G030073', 0.7199205824757151),
     ('G010189', 0.7185093279860888),
     ('G020056', 0.716180832538967),
     ('G010177', 0.7150427142348965),
     ('G030204', 0.7131091980247959),
     ('G020006', 0.7117142610078635),
     ('G010186', 0.7094965922180584),
     ('G020057', 0.7074727921580727),
     ('G010289', 0.7054939752812792),
     ('G020009', 0.7050545457657351),
     ('G030317', 0.7050358704114793),
     ('G030244', 0.7029358367189512),
     ('G010296', 0.700643053560183),
     ('G030241', 0.6971307765859306),
     ('G010213', 0.6970921507137584),
     ('G030012', 0.6964574854540967),
     ('G010272', 0.6918675373691229),
     ('G030269', 0.6901248871931651),
     ('G010191', 0.6887465356093256),
     ('G030134', 0.6836547146180784),
     ('G020004', 0.6824100880279166),
     ('G010244', 0.681620259143234),
     ('G010025', 0.6798152353210615),
     ('G010209', 0.6793133467995596),
     ('G030249', 0.6791056423874156),
     ('G010229', 0.6757868834974196),
     ('G010225', 0.6745093977680172),
     ('G010049', 0.6731845169604368),
     ('G030283', 0.6728778565623261),
     ('G030194', 0.6693149513714375),
     ('G030346', 0.6654809707400463),
     ('G020098', 0.664991930822252),
     ('G030341', 0.6649401445138334),
     ('G020002', 0.6647290979657577),
     ('G010259', 0.6578650403669155),
     ('G010141', 0.6557252290964035),
     ('G030029', 0.6538801850734575),
     ('G020125', 0.6528596575967642),
     ('G020061', 0.6498565290141006),
     ('G030218', 0.6469225482245006),
     ('G030074', 0.6467459944346869),
     ('G020045', 0.646265798888999),
     ('G010001', 0.6420246544879185),
     ('G030355', 0.6409169738930484),
     ('G020023', 0.638093913816688),
     ('G030209', 0.6341431161762943),
     ('G030235', 0.6280103206281529),
     ('G030196', 0.6269262971899376),
     ('G010273', 0.6268641930060961),
     ('G020035', 0.6263652971208863),
     ('G020052', 0.6250501752710521),
     ('G010238', 0.6222214910355982),
     ('G020026', 0.618000104223164),
     ('G010193', 0.6145799975562054),
     ('G010055', 0.6066870488607149),
     ('G010196', 0.6051257179747146),
     ('G010011', 0.6008077500624811),
     ('G030082', 0.600294000260745),
     ('G030268', 0.599359046589941),
     ('G020127', 0.5976277286074327),
     ('G010228', 0.5960610460401017),
     ('G010022', 0.5950372467102985),
     ('G030232', 0.5899594967837226),
     ('G010208', 0.5858745727725791),
     ('G030162', 0.585580918065156),
     ('G030191', 0.5838156560881637),
     ('G020085', 0.5833239322384208),
     ('G010024', 0.5811460109465882),
     ('G030105', 0.5810095865721138),
     ('G020015', 0.578695012805069),
     ('G030155', 0.5765384960581746),
     ('G010284', 0.5746744305317286),
     ('G020063', 0.574568852143423),
     ('G020071', 0.5731535583410093),
     ('G010232', 0.5709393409922792),
     ('G030332', 0.5704959784593978),
     ('G020033', 0.5638143142388305),
     ('G010233', 0.5609358383664045),
     ('G030264', 0.5552478788805428),
     ('G010153', 0.5522638464511403),
     ('G030347', 0.546342449203697),
     ('G020020', 0.5408546566800291),
     ('G030050', 0.5404883760234166),
     ('G030345', 0.5382569625011181),
     ('G010021', 0.5372129878821817),
     ('G020037', 0.5347754999457726),
     ('G010149', 0.5344294359118585),
     ('G020059', 0.5337613016914666),
     ('G030187', 0.5285079777998491),
     ('G020075', 0.5284433715936951),
     ('G030186', 0.5269926780922394),
     ('G030095', 0.5239359055988894),
     ('G010263', 0.5232934507304435),
     ('G030237', 0.5231539878120612),
     ('G010190', 0.5223872245084094),
     ('G030274', 0.5168391980750782),
     ('G030308', 0.5156721918768461),
     ('G030046', 0.5096453468085096),
     ('G030285', 0.5072886544150952),
     ('G010240', 0.5071649222580923),
     ('G030270', 0.5068301030837866),
     ('G020079', 0.5051349911447596),
     ('G030354', 0.50183156036422),
     ('G010040', 0.49471977771128295),
     ('G020047', 0.4922906727160054),
     ('G020024', 0.49193953344266594),
     ('G030304', 0.4909402389081076),
     ('G030120', 0.48524738539800105),
     ('G030044', 0.4848517491112647),
     ('G010248', 0.4784457861133213),
     ('G010089', 0.47797142352207705),
     ('G020030', 0.4779383071734745),
     ('G030314', 0.476563416385599),
     ('G010237', 0.47354897383594585),
     ('G010307', 0.4733389013735633),
     ('G030054', 0.4723390472823465),
     ('G010161', 0.4716974241746023),
     ('G030294', 0.47150691492715924),
     ('G010053', 0.4691344683253239),
     ('G030109', 0.46648148730418826),
     ('G010305', 0.46619660454579226),
     ('G030246', 0.46536529464246396),
     ('G030164', 0.46525161280885163),
     ('G030045', 0.46294315463179486),
     ('G030199', 0.4626452517091613),
     ('G010241', 0.46231405533255143),
     ('G020107', 0.46102786540511337),
     ('G020131', 0.4600837626423496),
     ('G030110', 0.4596429771878944),
     ('G010081', 0.45908661876128554),
     ('G030319', 0.4583743091524346),
     ('G030013', 0.45588093354882986),
     ('G030081', 0.45539386124402825),
     ('G010004', 0.45376665760591817),
     ('G010115', 0.45139570300741133),
     ('G010112', 0.45121417523942126),
     ('G030147', 0.4501119624784575),
     ('G010018', 0.4500929947542226),
     ('G030121', 0.44993953498764505),
     ('G030066', 0.4480396004130546),
     ('G010137', 0.44687218587288513),
     ('G010064', 0.4460344092477656),
     ('G030195', 0.44594108874174715),
     ('G030288', 0.4412930330508932),
     ('G010100', 0.4406193347605777),
     ('G010013', 0.43942791306150214),
     ('G010145', 0.4394229763354485),
     ('G030257', 0.43715104106110614),
     ('G020128', 0.4368349467660381),
     ('G030118', 0.4356285143483263),
     ('G030309', 0.43406138836241065),
     ('G030168', 0.43283929850943315),
     ('G030343', 0.4322944511673881),
     ('G010214', 0.4322699886743411),
     ('G010143', 0.4316368540649149),
     ('G020012', 0.4311643337305668),
     ('G010291', 0.4307977990034604),
     ('G030151', 0.4307733221110946),
     ('G020130', 0.4307341881551579),
     ('G010158', 0.4291249870319136),
     ('G020081', 0.42742234652713057),
     ('G030192', 0.4227084412631849),
     ('G020028', 0.422194838599006),
     ('G010095', 0.42035690553436794),
     ('G020072', 0.42022098331525337),
     ('G020065', 0.4192279353807223),
     ('G030001', 0.41836854413222585),
     ('G010125', 0.4167695384303233),
     ('G030357', 0.41515730377951343),
     ('G020031', 0.4126636733090326),
     ('G010275', 0.4083610021523045),
     ('G010182', 0.4075082995525416),
     ('G010255', 0.40708374880802495),
     ('G030130', 0.4065321124485623),
     ('G020036', 0.4056195380291512),
     ('G010122', 0.40243203714707787),
     ('G010019', 0.40150673050289987),
     ('G020022', 0.39975120053665275),
     ('G020126', 0.3988005822613528),
     ('G020003', 0.397713547132343),
     ('G010258', 0.39651280668448224),
     ('G030221', 0.3956238128427116),
     ('G010292', 0.39437753135423587),
     ('G010065', 0.392900680330077),
     ('G010138', 0.39185821962687634),
     ('G030087', 0.39018028001831795),
     ('G030211', 0.3865384998837767),
     ('G030279', 0.3848221578960069),
     ('G030324', 0.38230211868793207),
     ('G010079', 0.38143536848069104),
     ('G010293', 0.38008980581109425),
     ('G010054', 0.3754405879512839),
     ('G010242', 0.37461510834198236),
     ('G020110', 0.3724981649941558),
     ('G030064', 0.37085917223487896),
     ('G030021', 0.36995551188129844),
     ('G020108', 0.36951531681053096),
     ('G030203', 0.36950244200358906),
     ('G010043', 0.36945619651500344),
     ('G020073', 0.3693755234787596),
     ('G030112', 0.36800794414981264),
     ('G010288', 0.3670359743420029),
     ('G020080', 0.3665735255027308),
     ('G010282', 0.36497866151592645),
     ('G010280', 0.3639387511808639),
     ('G020068', 0.36390179068217554),
     ('G010133', 0.3628447972059835),
     ('G020095', 0.3617801491151642),
     ('G010195', 0.3609562452453572),
     ('G010170', 0.36062702212832076),
     ('G020007', 0.36019744926347685),
     ('G030129', 0.35788239459993904),
     ('G010154', 0.35731405885125805),
     ('G020076', 0.35604314822418376),
     ('G010216', 0.35502881648432033),
     ('G010178', 0.3546689085163622),
     ('G010116', 0.3546440629571426),
     ('G010211', 0.3538470715071138),
     ('G010279', 0.3528465083077867),
     ('G020067', 0.35041701690148386),
     ('G010175', 0.34993287773280074),
     ('G030287', 0.3493936887766757),
     ('G010085', 0.3485118531742127),
     ('G010088', 0.3483560132427042),
     ('G030198', 0.34715137711243244),
     ('G020104', 0.3457628625480613),
     ('G010023', 0.3438407137225127),
     ('G010131', 0.343512120426645),
     ('G010126', 0.3432324380618265),
     ('G030083', 0.3431301178960733),
     ('G010015', 0.3423575373872344),
     ('G030171', 0.3384391017561356),
     ('G020120', 0.33737692392773505),
     ('G020101', 0.3365511117739394),
     ('G010174', 0.33457957460663634),
     ('G030098', 0.33431143543461667),
     ('G020106', 0.33284267557460595),
     ('G030137', 0.3314667923433585),
     ('G020116', 0.33022264072759216),
     ('G010256', 0.3300527203457726),
     ('G030242', 0.3294510085485156),
     ('G020090', 0.3280468890917487),
     ('G030117', 0.3278349094902322),
     ('G030206', 0.32744671198928643),
     ('G010059', 0.326565866778694),
     ('G030006', 0.3256220865159493),
     ('G010124', 0.3256106892998258),
     ('G030136', 0.3240005998502235),
     ('G010270', 0.3232220321844936),
     ('G030282', 0.32261611744251656),
     ('G030166', 0.3206221598282614),
     ('G010200', 0.31962600462054513),
     ('G010003', 0.31951183282042817),
     ('G030106', 0.3193339619653607),
     ('G030256', 0.31894046968896467),
     ('G030349', 0.3181731601919859),
     ('G010044', 0.318124043887458),
     ('G010172', 0.3169996679132727),
     ('G030071', 0.31625729868450936),
     ('G010091', 0.3150432751673675),
     ('G020016', 0.3149942478850425),
     ('G030034', 0.3138518868445819),
     ('G010129', 0.31316434700537976),
     ('G010041', 0.31306134642488564),
     ('G030169', 0.3117079646603417),
     ('G020039', 0.3114972046326241),
     ('G010268', 0.3105830971119773),
     ('G010203', 0.3101011873318941),
     ('G010220', 0.30944512027316384),
     ('G030020', 0.30863093644355377),
     ('G030108', 0.30819470026607804),
     ('G010052', 0.30754078632209875),
     ('G030213', 0.30745215099658957),
     ('G010012', 0.307306280218229),
     ('G010278', 0.307028480456256),
     ('G010067', 0.3060307454615478),
     ('G020111', 0.3053233317154542),
     ('G010061', 0.30424605643950187),
     ('G030313', 0.3040470943234701),
     ('G010230', 0.30392642789258906),
     ('G030214', 0.3036840374581409),
     ('G030240', 0.30255106896112827),
     ('G020077', 0.3020858988226186),
     ('G010219', 0.30191573679728806),
     ('G030202', 0.30184025564117467),
     ('G010026', 0.3016772083011016),
     ('G030060', 0.30139182843028495),
     ('G010181', 0.30105173132864393),
     ('G030322', 0.3005537159293888),
     ('G020034', 0.3004565393761162),
     ('G030175', 0.29810582556886844),
     ('G010205', 0.2970641976595238),
     ('G030084', 0.2961238268795586),
     ('G030275', 0.29593289964507286),
     ('G010038', 0.2953433596344212),
     ('G030057', 0.294615350140204),
     ('G030188', 0.29306307750947747),
     ('G010071', 0.2913062995793362),
     ('G030311', 0.2912484217327134),
     ('G030325', 0.29094309235285065),
     ('G020005', 0.29087778398392994),
     ('G010123', 0.28964392805400996),
     ('G030351', 0.2893652724889756),
     ('G020019', 0.2893188998650148),
     ('G030252', 0.2886842746487613),
     ('G030228', 0.2878429718811275),
     ('G030033', 0.28776285042025357),
     ('G020074', 0.28765771408536067),
     ('G010057', 0.287201189370966),
     ('G010185', 0.2869274895262773),
     ('G010165', 0.2862647049576498),
     ('G030157', 0.2859369641236056),
     ('G010072', 0.28549969170022477),
     ('G030040', 0.2853639465124631),
     ('G020087', 0.2852624909821252),
     ('G030158', 0.284960599034974),
     ('G030114', 0.28464682850297585),
     ('G010173', 0.2837087172448882),
     ('G010159', 0.2832354002914138),
     ('G030075', 0.28321612946235886),
     ('G010105', 0.28317135055943243),
     ('G030096', 0.2831461465022897),
     ('G030356', 0.2824399960185313),
     ('G020112', 0.28101745410789203),
     ('G010295', 0.2809185120320059),
     ('G030077', 0.28037633407995155),
     ('G030238', 0.28026937231877463),
     ('G020093', 0.28007760063019077),
     ('G030014', 0.27986424277505245),
     ('G030220', 0.2789605607529477),
     ('G010051', 0.27893161279934986),
     ('G010147', 0.2789069788566387),
     ('G010245', 0.2787954534353869),
     ('G010183', 0.27834393101402954),
     ('G020119', 0.2780699410177657),
     ('G010187', 0.27805198090715194),
     ('G030116', 0.2779621624452914),
     ('G010163', 0.27683595110489084),
     ('G030201', 0.27562649712210696),
     ('G020097', 0.27562054790367113),
     ('G010082', 0.2755975919232927),
     ('G010148', 0.2753809166623158),
     ('G010031', 0.27537661980315714),
     ('G010251', 0.27489506041182143),
     ('G030159', 0.27460795515247577),
     ('G030210', 0.27450737747224613),
     ('G030174', 0.27441064961809514),
     ('G020124', 0.27430805707323963),
     ('G030255', 0.27333736890815),
     ('G030031', 0.27310704422417703),
     ('G030234', 0.2717057807502189),
     ('G020099', 0.2715281112098887),
     ('G020017', 0.2714568626314549),
     ('G020121', 0.27110609011617104),
     ('G020129', 0.2710689510694396),
     ('G010151', 0.27076127645884596),
     ('G020027', 0.2695410076478417),
     ('G030189', 0.2694071469747347),
     ('G020100', 0.2690970985115207),
     ('G030233', 0.2688509435010607),
     ('G030145', 0.26875843064538385),
     ('G010030', 0.26853593401113957),
     ('G010109', 0.26840742545071217),
     ('G010212', 0.2683362335681315),
     ('G030051', 0.2682104476454944),
     ('G010194', 0.26795778375364215),
     ('G030333', 0.267661350684196),
     ('G010157', 0.26565265273829886),
     ('G010207', 0.26544359739632173),
     ('G030225', 0.26536709146516385),
     ('G030127', 0.26536485723347436),
     ('G020054', 0.2652085162341897),
     ('G030251', 0.2651893519789645),
     ('G020066', 0.26455525954737696),
     ('G030111', 0.2640923813721409),
     ('G010239', 0.2639366934379913),
     ('G010250', 0.26341399498931783),
     ('G020018', 0.2630282681367641),
     ('G020088', 0.2628501804328617),
     ('G030331', 0.26277960419549407),
     ('G010114', 0.2624377237313305),
     ('G030135', 0.2623703625263198),
     ('G030260', 0.26196142802926714),
     ('G020043', 0.2616895169856705),
     ('G010134', 0.2606832538508781),
     ('G010300', 0.2601224724897164),
     ('G030091', 0.2593213500642895),
     ('G010188', 0.2585311779564704),
     ('G010168', 0.25804433676006494),
     ('G010039', 0.2577383729563463),
     ('G010146', 0.2573378940070908),
     ('G010048', 0.25705765345282683),
     ('G010094', 0.2563024630742215),
     ('G020132', 0.2561084670487996),
     ('G030089', 0.25574417159699064),
     ('G030165', 0.25505755963341115),
     ('G020084', 0.25471865362705987),
     ('G030230', 0.2544866167308886),
     ('G030315', 0.25442237907628834),
     ('G030131', 0.25436398406615),
     ('G010078', 0.25402936352902905),
     ('G010118', 0.25308733871478273),
     ('G020001', 0.2528335242017911),
     ('G020103', 0.25228503413320164),
     ('G010090', 0.25182716439455693),
     ('G030280', 0.25135914233626905),
     ('G010277', 0.2512212314241051),
     ('G030139', 0.25038401297973895),
     ('G010171', 0.25019610064489534),
     ('G030247', 0.2494336278367532),
     ('G010249', 0.24819773870607414),
     ('G030185', 0.24817265938119001),
     ('G030286', 0.24738945086907593),
     ('G010286', 0.24723015363249962),
     ('G010301', 0.24721856642483964),
     ('G030003', 0.24699768559246105),
     ('G030344', 0.24699766317829627),
     ('G020038', 0.24699547402910893),
     ('G030205', 0.24697713980659472),
     ('G010304', 0.24665639193046757),
     ('G030056', 0.2465726792040117),
     ('G010135', 0.24655739848197253),
     ('G030062', 0.24582796924830314),
     ('G030272', 0.2449674763952294),
     ('G020046', 0.24440999288063137),
     ('G030080', 0.24433374761879081),
     ('G010103', 0.24342238890628756),
     ('G010294', 0.24333147773611732),
     ('G010164', 0.2421301110621503),
     ('G020040', 0.24203347309532017),
     ('G030302', 0.2419873178659375),
     ('G010084', 0.241956281151674),
     ('G030122', 0.2416729057085998),
     ('G020058', 0.2414493695655881),
     ('G030119', 0.24087487449409725),
     ('G010285', 0.2403366744040058),
     ('G030028', 0.24029586612474896),
     ('G030053', 0.23982677270583128),
     ('G030172', 0.23978717914529823),
     ('G030115', 0.23945935256062642),
     ('G030025', 0.23917769078608403),
     ('G030303', 0.23787246607986184),
     ('G030298', 0.23691142971072152),
     ('G010045', 0.23656833036732922),
     ('G030126', 0.23586366940611014),
     ('G030090', 0.234942712114889),
     ('G010093', 0.23485996718263824),
     ('G010005', 0.2340814003472381),
     ('G030094', 0.23402704948572695),
     ('G030271', 0.23323605832708613),
     ('G030059', 0.23257693147314334),
     ('G010110', 0.2325508454525661),
     ('G030273', 0.23245862439481021),
     ('G010202', 0.23090964431625086),
     ('G030328', 0.23065014596211436),
     ('G010060', 0.2290251228697816),
     ('G030160', 0.22859105009899444),
     ('G030085', 0.2282848617739562),
     ('G010130', 0.22812033576964608),
     ('G010034', 0.22790806489226392),
     ('G020049', 0.22760398958462358),
     ('G020078', 0.22694369316461177),
     ('G020113', 0.2267909078660329),
     ('G010156', 0.2266002700937156),
     ('G010302', 0.22604603424520214),
     ('G010199', 0.2256024147821962),
     ('G030027', 0.22521300409080228),
     ('G010142', 0.2246697509150381),
     ('G030146', 0.22428682244165213),
     ('G010218', 0.2241447343322909),
     ('G010267', 0.22408764306782916),
     ('G030167', 0.2239059730038364),
     ('G010107', 0.22381487601490793),
     ('G030292', 0.22380277924527267),
     ('G010206', 0.22352270627113843),
     ('G030307', 0.22321494198496844),
     ('G030023', 0.22317930372465744),
     ('G010113', 0.22297732446675098),
     ('G030039', 0.22289654055314959),
     ('G020060', 0.22215909499176814),
     ('G010010', 0.2217610810817625),
     ('G030306', 0.22157360757392522),
     ('G030301', 0.22128424503287503),
     ('G030284', 0.22038489187497637),
     ('G030173', 0.2200032911440055),
     ('G030125', 0.21988395511709508),
     ('G010083', 0.21925488242737365),
     ('G030052', 0.2189435915941431),
     ('G030316', 0.2182386921714386),
     ('G030102', 0.21755415248002524),
     ('G010068', 0.21679223318602528),
     ('G030043', 0.21670656631693558),
     ('G010092', 0.21640872469850966),
     ('G010236', 0.21614529052231474),
     ('G030063', 0.2159626161891425),
     ('G010221', 0.21582256712174977),
     ('G030329', 0.2156426639576967),
     ('G020032', 0.21548815883430897),
     ('G010276', 0.21508826599434416),
     ('G020089', 0.21496594239416492),
     ('G030037', 0.21495102645285336),
     ('G010139', 0.2146272065364476),
     ('G010058', 0.21454470946864596),
     ('G030281', 0.21452614619377042),
     ('G010070', 0.2145088660610257),
     ('G020114', 0.21444162185515134),
     ('G030058', 0.21430308826818537),
     ('G010101', 0.21400223782087638),
     ('G030099', 0.21359966676707653),
     ('G010283', 0.21305376117284386),
     ('G030163', 0.21270892422295648),
     ('G010274', 0.2125742445363922),
     ('G030350', 0.21248987295887029),
     ('G010069', 0.21229508236472008),
     ('G030215', 0.2122491398320453),
     ('G010254', 0.21190214311545638),
     ('G010179', 0.21123812641320389),
     ('G020044', 0.2111638398639759),
     ('G030312', 0.21111468365160715),
     ('G030141', 0.21065848048454294),
     ('G030358', 0.21046843171260635),
     ('G010184', 0.21026012995926002),
     ('G030170', 0.2090867701606362),
     ('G030182', 0.2068585731481224),
     ('G010099', 0.20603068139870961),
     ('G030144', 0.20564602943318722),
     ('G010020', 0.2051632890521995),
     ('G010303', 0.2050486806811661),
     ('G010042', 0.20431019859090166),
     ('G010197', 0.20398722350457948),
     ('G020115', 0.2038987540607695),
     ('G010217', 0.20377312918603135),
     ('G010180', 0.20339704911847398),
     ('G010247', 0.20339583191303207),
     ('G030266', 0.20326233359920184),
     ('G010287', 0.20322874925782514),
     ('G010046', 0.2018232394312205),
     ('G020086', 0.20178523352599387),
     ('G030128', 0.2013441322752297),
     ('G010102', 0.20107717216619264),
     ('G030239', 0.20104686394300755),
     ('G030348', 0.20101092747788152),
     ('G010047', 0.2009905154793635),
     ('G020123', 0.20090514437501886),
     ('G030318', 0.20088941461183557),
     ('G010117', 0.1997462335687906),
     ('G030254', 0.19885580464317038),
     ('G030088', 0.19844843807213894),
     ('G030219', 0.1972874928245052),
     ('G010076', 0.19676838823801435),
     ('G010121', 0.1966559661043898),
     ('G010036', 0.196470414319022),
     ('G010077', 0.19477738915551643),
     ('G030263', 0.19473175844118343),
     ('G030007', 0.19400862843489855),
     ('G010050', 0.19374043415498357),
     ('G030212', 0.1926108410377676),
     ('G010062', 0.19232266203488327),
     ('G020055', 0.19185117325448645),
     ('G030193', 0.1917158271897455),
     ('G030297', 0.19067187936594285),
     ('G030004', 0.19049893139939458),
     ('G010144', 0.19039756810754566),
     ('G030207', 0.18879184711525585),
     ('G030177', 0.1881361023501489),
     ('G010265', 0.18802534135180582),
     ('G030150', 0.18745727428753578),
     ('G030181', 0.18729439587480914),
     ('G030156', 0.18706295055236252),
     ('G030002', 0.18702586327338344),
     ('G030093', 0.18538176870744533),
     ('G030100', 0.18323656730585133),
     ('G010192', 0.18277832409735598),
     ('G010290', 0.1826054218883795),
     ('G010087', 0.18239443028818417),
     ('G010098', 0.18227686260123266),
     ('G030323', 0.18227309455523755),
     ('G030103', 0.18158976546923572),
     ('G010074', 0.18134118362740675),
     ('G030097', 0.18090536966475226),
     ('G010002', 0.17982038267791137),
     ('G030153', 0.17978827911302822),
     ('G010155', 0.17930804793668262),
     ('G010136', 0.17918503880360379),
     ('G030132', 0.17869628740157106),
     ('G010029', 0.17690413390823242),
     ('G030061', 0.1765128747914804),
     ('G010281', 0.17615395556707972),
     ('G030223', 0.1756667625876351),
     ('G010096', 0.17439440716511329),
     ('G010224', 0.1728849553055273),
     ('G030267', 0.17269195350085167),
     ('G020122', 0.17228653878341682),
     ('G010037', 0.1721333807961997),
     ('G010298', 0.17067432494712728),
     ('G010128', 0.17030645986030593),
     ('G010308', 0.16986389291912501),
     ('G010097', 0.1698630514218904),
     ('G030065', 0.16909696368981295),
     ('G010167', 0.1664867483413591),
     ('G010150', 0.16628628051534314),
     ('G030236', 0.16366542944647725),
     ('G020013', 0.1632828424411783),
     ('G020083', 0.16231720064095878),
     ('G020091', 0.16163639533551144),
     ('G030299', 0.16061921835518214),
     ('G010266', 0.15641625979754156),
     ('G030078', 0.1561380241362043),
     ('G010210', 0.155449998182695),
     ('G010080', 0.1545759314647171),
     ('G010226', 0.15370547198246096),
     ('G030019', 0.1528286380847534),
     ('G030133', 0.15206394197289982),
     ('G030015', 0.14927060674099998),
     ('G010006', 0.14794655152260827),
     ('G030259', 0.14779728337141998),
     ('G030296', 0.14404593552370457),
     ('G010152', 0.14272155593133087),
     ('G010231', 0.1411284314429591),
     ('G010257', 0.13777935470881758),
     ('G010086', 0.1366424439745453),
     ('G030138', 0.1365453701009832),
     ('G010120', 0.13497607161587066),
     ('G030016', 0.1349726198496276),
     ('G020092', 0.1333920967697482),
     ('G020062', 0.13290305773966804),
     ('G030038', 0.13189610195581536),
     ('G030291', 0.13107953338056536),
     ('G010127', 0.13099309879600987),
     ('G030224', 0.12866016306423178),
     ('G020021', 0.12634758076249067),
     ('G020042', 0.1231435845586116),
     ('G010252', 0.12039988427527702),
     ('G030342', 0.1199513172236652),
     ('G010106', 0.11805456947351461),
     ('G030352', 0.11681686557553915),
     ('G010299', 0.11530248618239121),
     ('G030353', 0.11445502414756031),
     ('G030152', 0.11370505706672258),
     ('G030076', 0.11211719743097419),
     ('G020029', 0.10877994057273359),
     ('G010017', 0.09704792666898092),
     ('G010063', 0.09264113240975877),
     ('G010073', 0.08390213182377519),
     ('G010264', 0.08267621333157271),
     ('G010104', 0.06503783186995007)]



## 3. 利用個人喜好分數，搭配三種推薦策略，建構推薦清單


```python
def drama_feature_ind(histroryDrama, user_ip):
    
    UserItemDict, UserItemDictPositiveGrade, UserItemDictGrade, dramaName_list, dramaName_list2=data_processing(histroryDrama, user_ip)
    df_drama_zone_genre_actor_ind=pd.DataFrame()

    for i in UserItemDict[user_ip]:
        df_drama_feature=df_drama_zone_genre_actor_all[df_drama_zone_genre_actor_all['dramaID']==i]
        df_drama_zone_genre_actor_ind=df_drama_zone_genre_actor_ind.append(df_drama_feature)

    return df_drama_zone_genre_actor_ind
```

### 3.1 推薦策略一：利用使用者收藏清單判斷其偏好戲劇類型，將這些類型的戲劇抽取出來，利用個人喜好分數進行排序


```python
def preferGenre(histroryDrama, user_ip):
    

    # 利用使用者過去的收藏清單判斷其偏好的戲劇類型(取前三種)
    df_drama_zone_genre_actor_ind=drama_feature_ind(histroryDrama, user_ip)
    drama_list_exclude=df_drama_zone_genre_actor_ind['dramaID'].tolist()

    index_list=list(df_drama_zone_genre_actor_ind.mean(axis=0).index)[3:28]
    grade_list=list(df_drama_zone_genre_actor_ind.mean(axis=0))[3:28]
    ind_preference={}
    for i in range(len(index_list)):
        ind_preference[index_list[i]]=grade_list[i]
    genre_prefer=sorted(ind_preference.items(), key=lambda d: d[1], reverse=True)
    
    #將這些類型的戲劇抽取出來
    df_Drama_prefer=df_Drama_GenreName[(df_Drama_GenreName['genreName']==genre_prefer[0][0]) \
                                       | (df_Drama_GenreName['genreName']==genre_prefer[1][0])\
                                       | (df_Drama_GenreName['genreName']==genre_prefer[2][0])]

    df_Drama_prefer_list=df_Drama_prefer['dramaID'].tolist()
                                       
    #利用個人喜好分數進行排序, 但排除使用者已經收藏的戲劇
    personal_rec={}
    for i in df_Drama_prefer_list:
        try:
            personal_rec[i]=rank_LMF[user_ip][i]        
        except:
            pass

    personal_rec1=sorted(personal_rec.items(), key=lambda x:-x[1])

    personal_rec1_list=[]
    for i in personal_rec1:
        if i[0] in drama_list_exclude:
            pass
        else:
            personal_rec1_list.append(i[0])

    return personal_rec1_list   
```

### 3.2 推薦策略二：利用豆辨評分找出前100部評分最高的戲劇，將這些戲劇抽取出來，利用個人喜好分數進行排序


```python
def popular(histroryDrama, user_ip):
    
    df_drama_zone_genre_actor_ind=drama_feature_ind(histroryDrama, user_ip)
    personal_rec1_list=preferGenre(histroryDrama, user_ip)
    drama_list_exclude=df_drama_zone_genre_actor_ind['dramaID'].tolist()

    #利用豆辨評分找出前100部評分最高的戲劇
    pop=tbl_Drama.sort_values('hitto', ascending=False).head(100)
    df_pop_prefer_list=pop['dramaID'].tolist()
    
    #利用個人喜好分數進行排序, 但排除使用者已經收藏或是已出現在「推薦策略一」的戲劇
    pop_rec={}
    for i in df_pop_prefer_list:
        try:
            pop_rec[i]=rank_LMF[user_ip][i]        
        except:
            pass

    pop_rec1=sorted(pop_rec.items(), key=lambda x:-x[1])

    pop_rec1_list=[]
    for i in pop_rec1:
        if i[0] in personal_rec1_list[0:3]+drama_list_exclude:
            pass
        else:
            pop_rec1_list.append(i[0])

    return pop_rec1_list
```

### 3.3 推薦策略三：找出近6個月出版的新劇，將這些戲劇抽取出來，利用個人喜好分數進行排序


```python
def latest(histroryDrama, user_ip):
    
    df_drama_zone_genre_actor_ind=drama_feature_ind(histroryDrama, user_ip)
    personal_rec1_list=preferGenre(histroryDrama, user_ip)
    pop_rec1_list=popular(histroryDrama, user_ip)
    drama_list_exclude=df_drama_zone_genre_actor_ind['dramaID'].tolist()
    
    #找出近6個月出版的新劇
    latest=tbl_Drama.sort_values('publishTime', ascending=False).head(60)
    df_latest_prefer_list=latest['dramaID'].tolist()
    
    #利用個人喜好分數進行排序, 但排除使用者已經收藏或是已出現在「推薦策略一」及「推薦策略二」的戲劇
    latest_rec={}
    for i in df_latest_prefer_list:
        try:
            latest_rec[i]=rank_LMF[user_ip][i]       
        except:
            pass

    latest_rec1=sorted(latest_rec.items(), key=lambda x:-x[1])
    
    latest_rec1_list=[]
    for i in latest_rec1:
        if i[0] in personal_rec1_list[0:3]+pop_rec1_list[0:3]+drama_list_exclude:
            pass
        else:
            latest_rec1_list.append(i[0])

    return latest_rec1_list
```

### 3.4 推薦清單


```python
histroryDrama=[('127.0.0.1', 'G020073'), ('127.0.0.1', 'G010012'), ('127.0.0.1', 'G010003'), ('127.0.0.1', 'G010002'), \
                  ('127.0.0.1', 'G010005'),('127.0.0.1', 'G010056'), ('127.0.0.1', 'G010169'), ('127.0.0.1', 'G020041') ]

personal_rec1_list=preferGenre(histroryDrama, '127.0.0.1')
pop_rec1_list=popular(histroryDrama, '127.0.0.1')
latest_rec1_list=latest(histroryDrama, '127.0.0.1')

print(personal_rec1_list[0:3])
print(pop_rec1_list[0:3])
print(latest_rec1_list[0:3])
```

    ['G010269', 'G030176', 'G030243']
    ['G010008', 'G030104', 'G010297']
    ['G010306', 'G030073', 'G010289']
    
